name: Notify Downstream

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send downstream notification
        run: |
          echo "Sending repository dispatch to: ${{ secrets.DOWNSTREAM_WEBHOOK_URL }}"
          
          # Capture both response body and HTTP status code
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.DOWNSTREAM_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.DOWNSTREAM_WEBHOOK_URL }}" \
            -d @- <<'EOF'
          {
            "event_type": "source-updated",
            "client_payload": {
              "ref": "${{ github.event.release.tag_name }}",
              "sha": "${{ github.sha }}",
              "release_id": "${{ github.event.release.id }}"
            }
          }
          EOF
          )
          
          # Extract HTTP status code (last line) and response body (everything else)
          http_code=$(echo "$response" | tail -n 1)
          response_body=$(echo "$response" | head -n -1)
          
          echo "HTTP Status: $http_code"
          if [ -n "$response_body" ]; then
            echo "Response Body: $response_body"
          fi
          
          # Repository dispatch returns 204 No Content on success
          if [ "$http_code" = "204" ]; then
            echo "✓ Repository dispatch sent successfully"
          else
            echo "✗ Repository dispatch failed with status $http_code"
            echo "This could indicate:"
            echo "  - Invalid token or insufficient permissions"
            echo "  - Incorrect repository URL"
            echo "  - Target repository doesn't exist or isn't accessible"
            exit 1
          fi